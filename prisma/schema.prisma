generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------
// ENUMS
// ---------------------------------------------------------

enum UserRole {
  SUPER_ADMIN // System owner (optional for future)
  ADMIN       // Gym owner / Personal
  TRAINER     // Employee (Reviewer?)
  STUDENT     // End user
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum ExerciseCategory {
  STRENGTH
  CARDIO
  FLEXIBILITY
  BALANCE
  HIIT
  OTHER
}

// ---------------------------------------------------------
// CORE MULTI-TENANCY
// ---------------------------------------------------------

model Tenant {
  id                String   @id @default(uuid())
  name              String
  document          String?   // CPF or CNPJ
  logo_url          String?
  primaryColor      String   @default("#ef4444") // UI theme color
  type              String?  // 'academy' | 'personal'
  status            String   @default("active") // 'active' | 'suspended'
  subscription_plan String   @default("FREE")
  subscription_plan_id String? // FK to SubscriptionPlan
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  users    User[]
  students Student[]
  workouts Workout[]
  logs     WorkoutLog[]
  messages Message[]
  schedules Schedule[]

  @@map("tenants")
}

// ---------------------------------------------------------
// AUTHENTICATION (NextAuth Compatible)
// ---------------------------------------------------------

model User {
  id            String    @id @default(uuid())
  tenant_id     String
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For Credentials provider
  role          UserRole  @default(STUDENT)
  is_owner      Boolean   @default(false) // Tenant owner flag
  subscription_status String? // 'active' | 'past_due' | 'canceled' | 'trialing'
  subscription_plan_id String?
  must_change_password Boolean @default(false)
  password_reset_token String?
  password_reset_expires DateTime?
  last_login    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // App relations
  trainer_students Student[] @relation("TrainerStudents") // Students this user trains (as a Trainer)
  student_profile  Student?  @relation("UserStudentProfile") // The student profile if this user is a Student
  workouts_created Workout[] // Workouts created by this user (Trainer/Admin)
  
  sent_messages     Message[] @relation("SentMessages")
  received_messages Message[] @relation("ReceivedMessages")
  schedules_created Schedule[] @relation("TrainerSchedules")

  @@index([tenant_id])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ---------------------------------------------------------
// DOMAIN MODELS
// ---------------------------------------------------------

model Student {
  id         String        @id @default(uuid())
  tenant_id  String
  user_id    String        @unique // Link to the Auth User
  trainer_id String?       // Assigned Trainer
  status     StudentStatus @default(ACTIVE)
  
  // Profile fields from original
  age        Int?
  gender     String?       // 'M' | 'F'
  weight     Float?
  height     Float?
  goal       String?       // 'Hipertrofia' | 'Emagrecimento' | 'Resistência' | 'Força'
  level      String?       // 'Iniciante' | 'Intermediário' | 'Avançado'
  injuries   String?       @db.Text
  medical_notes String?    @db.Text
  last_checkin DateTime?
  
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt

  tenant  Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user    User   @relation("UserStudentProfile", fields: [user_id], references: [id], onDelete: Cascade)
  trainer User?  @relation("TrainerStudents", fields: [trainer_id], references: [id])

  workouts Workout[]
  logs     WorkoutLog[]
  schedules Schedule[]
  measurements BodyMeasurement[]
  assessments PhysicalAssessment[]

  @@index([tenant_id])
  @@index([trainer_id])
  @@map("students")
}

model Workout {
  id          String   @id @default(uuid())
  tenant_id   String
  student_id  String
  trainer_id  String // Creator of the workout
  name        String
  objective   String?
  expires_at  DateTime?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  student Student @relation(fields: [student_id], references: [id], onDelete: Cascade)
  trainer User    @relation(fields: [trainer_id], references: [id])

  exercises Exercise[]
  logs      WorkoutLog[]

  @@index([tenant_id])
  @@index([student_id])
  @@index([trainer_id])
  @@map("workouts")
}

model Exercise {
  id           String           @id @default(uuid())
  workout_id   String
  name         String
  category     ExerciseCategory @default(OTHER)
  media_url    String?
  sets         Int?
  reps         Int?
  weight       Float?
  rest_seconds Int?
  notes        String?
  created_at   DateTime         @default(now())

  workout Workout @relation(fields: [workout_id], references: [id], onDelete: Cascade)

  @@index([workout_id])
  @@map("exercises")
}

// ---------------------------------------------------------
// LOGS & HISTORY
// ---------------------------------------------------------

model WorkoutLog {
  id               String   @id @default(uuid())
  tenant_id        String
  student_id       String
  workout_id       String
  duration_seconds Int
  date             DateTime @default(now())
  
  // Relations
  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  student Student @relation(fields: [student_id], references: [id], onDelete: Cascade)
  workout Workout @relation(fields: [workout_id], references: [id])

  exercises WorkoutLogExercise[]

  @@index([tenant_id])
  @@index([student_id])
  @@map("workout_logs")
}

model WorkoutLogExercise {
  id             String @id @default(uuid())
  workout_log_id String
  exercise_name  String
  sets_done      Int
  reps_done      Int
  weight_used    Float

  log WorkoutLog @relation(fields: [workout_log_id], references: [id], onDelete: Cascade)

  @@index([workout_log_id])
  @@map("workout_log_exercises")
}

// ---------------------------------------------------------
// CHAT
// ---------------------------------------------------------

model Message {
  id          String   @id @default(uuid())
  tenant_id   String
  sender_id   String
  receiver_id String
  content     String
  read_at     DateTime?
  created_at  DateTime @default(now())

  tenant   Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  sender   User   @relation("SentMessages", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver User   @relation("ReceivedMessages", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([sender_id])
  @@index([receiver_id])
  @@map("messages")
}

// ---------------------------------------------------------
// SCHEDULE
// ---------------------------------------------------------

model Schedule {
  id          String   @id @default(uuid())
  tenant_id   String
  trainer_id  String
  student_id  String?
  title       String
  start_time  DateTime
  end_time    DateTime
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  trainer User    @relation("TrainerSchedules", fields: [trainer_id], references: [id], onDelete: Cascade)
  student Student? @relation(fields: [student_id], references: [id])

  @@index([tenant_id])
  @@index([trainer_id])
  @@index([student_id])
  @@map("schedules")
}

// ---------------------------------------------------------
// TRACKING (EVOLUTION)
// ---------------------------------------------------------

model BodyMeasurement {
  id          String   @id @default(uuid())
  student_id  String
  weight      Float?
  height      Float?
  body_fat    Float? // %
  muscle_mass Float? // kg or %? Let's assume kg for now or just generic number
  notes       String?
  date        DateTime @default(now())
  created_at  DateTime @default(now())

  student Student @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@index([student_id])
  @@map("body_measurements")
}


// ---------------------------------------------------------
// PHYSICAL ASSESSMENT (Complete from original)
// ---------------------------------------------------------

model PhysicalAssessment {
  id                    String   @id @default(uuid())
  tenant_id             String
  student_id            String
  date                  DateTime @default(now())
  weight                Float
  height                Float
  age_at_assessment     Int
  
  // Circumferences (cm)
  neck_cm               Float?
  chest_cm              Float?
  waist_cm              Float?
  abdomen_cm            Float?
  hips_cm               Float?
  arm_right_cm          Float?
  arm_left_cm           Float?
  thigh_right_cm        Float?
  thigh_left_cm         Float?
  calf_cm               Float?
  
  // Skinfolds (mm)
  skinfold_triceps      Float?
  skinfold_subscapular  Float?
  skinfold_chest        Float?
  skinfold_midaxillary  Float?
  skinfold_suprailiac   Float?
  skinfold_abdominal    Float?
  skinfold_thigh        Float?
  
  // Calculated metrics
  bmi                   Float
  body_fat_percentage   Float?
  waist_hip_ratio       Float?
  lean_mass_kg          Float?
  fat_mass_kg           Float?
  
  // Photos
  photo_front_url       String?
  photo_back_url        String?
  photo_side_url        String?
  
  notes                 String?  @db.Text
  deleted_at            DateTime?
  created_at            DateTime @default(now())
  
  student Student @relation(fields: [student_id], references: [id], onDelete: Cascade)
  
  @@index([tenant_id])
  @@index([student_id])
  @@map("physical_assessments")
}

// ---------------------------------------------------------
// NOTIFICATIONS
// ---------------------------------------------------------

model Notification {
  id         String   @id @default(uuid())
  user_id    String
  type       String   // 'booking' | 'cancellation' | 'reminder' | 'info' | 'message'
  title      String
  message    String   @db.Text
  read       Boolean  @default(false)
  data       Json?    // Additional data as JSON
  created_at DateTime @default(now())
  
  @@index([user_id])
  @@index([read])
  @@map("notifications")
}

// ---------------------------------------------------------
// AUTO MESSAGE CONFIG (Templates)
// ---------------------------------------------------------

model AutoMessageConfig {
  id                            String  @id @default(uuid())
  tenant_id                     String  @unique
  
  // Reminders
  reminder_24h_active           Boolean @default(false)
  reminder_24h_time             String  @default("09:00")
  reminder_24h_text             String  @db.Text
  reminder_2h_active            Boolean @default(false)
  reminder_2h_text              String  @db.Text
  reminder_now_active           Boolean @default(false)
  reminder_now_text             String  @db.Text
  
  // Alerts
  alert_missed_student_active   Boolean @default(false)
  alert_missed_student_text     String  @db.Text
  alert_missed_trainer_active   Boolean @default(false)
  alert_missed_critical_active  Boolean @default(false)
  alert_missed_critical_text    String  @db.Text
  
  // Assessment reminders
  assessment_reminder_active    Boolean @default(false)
  assessment_reminder_days      Int     @default(30)
  assessment_reminder_text      String  @db.Text
  
  // Photo reminders
  photo_reminder_active         Boolean @default(false)
  photo_reminder_days           Int     @default(30)
  photo_reminder_text           String  @db.Text
  
  // Motivational messages
  motivational_workout_active   Boolean @default(false)
  motivational_workout_text     String  @db.Text
  motivational_streak_active    Boolean @default(false)
  motivational_streak_days      Int     @default(7)
  motivational_streak_text      String  @db.Text
  motivational_record_active    Boolean @default(false)
  motivational_record_text      String  @db.Text
  
  // Welcome message
  welcome_active                Boolean @default(true)
  welcome_text                  String  @db.Text
  
  @@map("auto_message_configs")
}

// ---------------------------------------------------------
// SUBSCRIPTION & BILLING
// ---------------------------------------------------------

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  price       Float
  interval    String   // 'monthly' | 'yearly'
  features    String[] // Array of features
  active      Boolean  @default(true)
  created_at  DateTime @default(now())
  
  @@map("subscription_plans")
}

model Payment {
  id          String   @id @default(uuid())
  tenant_id   String
  amount      Float
  status      String   // 'paid' | 'open' | 'void' | 'uncollectible'
  method      String?  // 'credit_card' | 'pix' | 'boleto'
  paid_at     DateTime?
  invoice_url String?
  created_at  DateTime @default(now())
  
  @@index([tenant_id])
  @@map("payments")
}

// ---------------------------------------------------------
// AUDIT LOG
// ---------------------------------------------------------

model AuditLog {
  id              String   @id @default(uuid())
  actor_id        String
  actor_email     String
  action          String   // 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN' | etc
  target_resource String   // 'Student' | 'Workout' | 'User' | etc
  details         String?  @db.Text
  ip_address      String
  created_at      DateTime @default(now())
  
  @@index([actor_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}
